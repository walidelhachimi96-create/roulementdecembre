<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÑ ONCF Roulement - Gestion des Gares</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Roboto:wght@300;400;500;700;900&display=swap');
        
        * { 
            scrollbar-width: thin; 
            scrollbar-color: #dc2626 #1e293b;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(90deg, transparent, transparent 45px, rgba(220, 38, 38, 0.1) 45px, rgba(220, 38, 38, 0.1) 50px),
                repeating-linear-gradient(0deg, transparent, transparent 45px, rgba(220, 38, 38, 0.1) 45px, rgba(220, 38, 38, 0.1) 50px);
            pointer-events: none;
            opacity: 0.3;
            z-index: 0;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes trainMove {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.8s ease-out; }
        .animate-pulse-slow { animation: pulse 3s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.6s ease-out; }
        .animate-blink { animation: blink 2s ease-in-out infinite; }
        
        .train-bg {
            position: fixed;
            bottom: 20px;
            font-size: 60px;
            animation: trainMove 15s linear infinite;
            z-index: 0;
            opacity: 0.2;
            pointer-events: none;
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(220, 38, 38, 0.3);
            box-shadow: 0 25px 50px rgba(220, 38, 38, 0.2), inset 0 0 20px rgba(220, 38, 38, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .oncf-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
            border: 3px solid #fbbf24;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.5), inset 0 0 20px rgba(251, 191, 36, 0.2);
        }
        
        .scroll-container { 
            height: 60vh; 
            overflow: auto !important; 
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5), 0 0 30px rgba(220, 38, 38, 0.3);
            border: 3px solid #dc2626;
        }
        
        .scroll-container::-webkit-scrollbar { width: 18px; height: 18px; }
        .scroll-container::-webkit-scrollbar-track { 
            background: linear-gradient(to bottom, #1e293b, #0f172a); 
            border-radius: 18px; 
        }
        .scroll-container::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #dc2626, #991b1b); 
            border-radius: 18px; 
            border: 3px solid #1e293b;
            transition: all 0.3s;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.8);
        }
        
        .table-container { 
            table-layout: fixed; 
            width: 100%; 
            min-width: 2200px; 
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th, td { 
            padding: 14px 8px; 
            text-align: center; 
            border-right: 2px solid rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
        }
        
        th { 
            position: sticky !important; 
            top: 0 !important; 
            z-index: 100 !important; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important; 
            color: #fbbf24 !important; 
            font-weight: 900 !important; 
            font-size: 13px !important; 
            height: 55px !important;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8), 0 0 10px rgba(251, 191, 36, 0.5);
            letter-spacing: 1px;
            font-family: 'Orbitron', sans-serif;
            border-bottom: 3px solid #dc2626;
        }
        
        .th-worker { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 120 !important; 
            background: linear-gradient(135deg, #dc2626, #991b1b, #7f1d1d) !important; 
            width: 130px !important;
            box-shadow: 4px 0 15px rgba(220, 38, 38, 0.5);
            border-right: 3px solid #fbbf24;
        }
        
        .th-total { 
            position: sticky !important; 
            right: 0 !important; 
            z-index: 120 !important; 
            background: linear-gradient(135deg, #059669, #047857, #065f46) !important; 
            width: 90px !important;
            box-shadow: -4px 0 15px rgba(5, 150, 105, 0.5);
            border-left: 3px solid #fbbf24;
        }
        
        .day-cell { width: 65px !important; min-width: 65px !important; }
        
        td { 
            font-size: 11px; 
            font-weight: 700; 
            height: 50px; 
            vertical-align: middle;
            background: rgba(15, 23, 42, 0.6);
        }
        
        .td-worker { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 90 !important; 
            background: linear-gradient(135deg, #7f1d1d, #991b1b) !important; 
            width: 130px !important; 
            font-weight: 900 !important; 
            font-size: 13px !important;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
            color: #fbbf24 !important;
            border-right: 3px solid rgba(251, 191, 36, 0.3);
        }
        
        .td-total { 
            position: sticky !important; 
            right: 0 !important; 
            z-index: 90 !important; 
            background: linear-gradient(135deg, #065f46, #047857) !important; 
            width: 90px !important; 
            font-weight: 900 !important; 
            font-size: 16px !important;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.5);
            color: #fbbf24 !important;
            border-left: 3px solid rgba(251, 191, 36, 0.3);
        }
        
        .cell-hover:hover {
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 12px 30px rgba(220, 38, 38, 0.6);
            z-index: 50;
            cursor: pointer;
        }
        
        .btn-oncf {
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            border: 2px solid #fbbf24;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
        }
        
        .btn-oncf:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.7), 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #dc2626;
            transition: all 0.4s ease;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 25px 50px rgba(220, 38, 38, 0.5);
            border-color: #fbbf24;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #059669, #047857);
            animation: pulse 2s infinite;
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(5, 150, 105, 0.6);
        }
        
        .badge-error {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            animation: pulse 2s infinite;
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.6);
        }
        
        .station-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
            animation: blink 2s infinite;
            margin-right: 8px;
        }
        
        .oncf-logo {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8), 0 0 20px rgba(251, 191, 36, 0.6);
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <div class="train-bg">üöÑ</div>
    <div id="root"></div>

    <script type="text/javascript">
        const { useState, useEffect } = React;
        const e = React.createElement;

        function generateSchedule(year, month, numWorkers) {
            const schedule = [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const POSITIONS = ['Gare-M', 'Port-M', 'Neuf-S', 'Gare-S', 'Port-S'];
            
            const workers = Array.from({length: numWorkers}, () => ({
                consecutiveWork: 0,
                consecutiveMorning: 0,
                consecutiveSoir: 0,
                lastShift: null,
                nextRestPattern: 1,
                ongoingRestDays: 0,
                totalRestDays: 0,
                totalReserveDays: 0
            }));
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = { date: day, workers: Array(numWorkers).fill('') };
                
                const inRest = [];
                for (let w = 0; w < numWorkers; w++) {
                    if (workers[w].ongoingRestDays > 0) {
                        dayData.workers[w] = `Repos (${workers[w].nextRestPattern}j)`;
                        workers[w].ongoingRestDays--;
                        workers[w].totalRestDays++;
                        inRest.push(w);
                        
                        if (workers[w].ongoingRestDays === 0) {
                            workers[w].consecutiveWork = 0;
                            workers[w].consecutiveMorning = 0;
                            workers[w].consecutiveSoir = 0;
                            workers[w].lastShift = null;
                            workers[w].nextRestPattern = workers[w].nextRestPattern === 1 ? 2 : 1;
                        }
                    }
                }
                
                const available = [];
                for (let w = 0; w < numWorkers; w++) {
                    if (!inRest.includes(w)) {
                        available.push(w);
                    }
                }
                
                if (available.length < 6) {
                    available.sort((a, b) => workers[a].consecutiveWork - workers[b].consecutiveWork);
                    const shuffled = [...POSITIONS].sort(() => Math.random() - 0.5);
                    
                    for (let i = 0; i < Math.min(5, available.length); i++) {
                        const w = available[i];
                        const pos = shuffled[i];
                        const shift = pos.endsWith('-M') ? 'M' : 'S';
                        
                        dayData.workers[w] = pos;
                        workers[w].consecutiveWork++;
                        workers[w].lastShift = shift;
                        
                        if (shift === 'M') {
                            workers[w].consecutiveMorning++;
                            workers[w].consecutiveSoir = 0;
                        } else {
                            workers[w].consecutiveSoir++;
                            workers[w].consecutiveMorning = 0;
                        }
                    }
                    
                    if (available.length > 5) {
                        const w = available[5];
                        dayData.workers[w] = 'R√©serve';
                        workers[w].consecutiveWork++;
                        workers[w].totalReserveDays++;
                        workers[w].lastShift = null;
                    }
                    
                    for (let w = 0; w < numWorkers; w++) {
                        if (dayData.workers[w] === '') {
                            dayData.workers[w] = 'Repos (1j)';
                            workers[w].totalRestDays++;
                        }
                    }
                    
                    schedule.push(dayData);
                    continue;
                }
                
                const mustRest = [];
                for (let w of available) {
                    let needRest = false;
                    let restDays = 1;
                    
                    if (workers[w].consecutiveMorning >= 5) {
                        needRest = true;
                        restDays = 2;
                    } else if (workers[w].consecutiveSoir >= 5) {
                        needRest = true;
                        restDays = 1;
                    } else if (workers[w].consecutiveWork >= 6) {
                        needRest = true;
                        restDays = 2;
                    } else if (workers[w].consecutiveWork >= 5) {
                        needRest = true;
                        restDays = workers[w].nextRestPattern;
                    }
                    
                    if (needRest) {
                        mustRest.push({worker: w, days: restDays});
                    }
                }
                
                let restGiven = 0;
                for (let rest of mustRest) {
                    if (available.length - restGiven <= 6) break;
                    
                    const w = rest.worker;
                    dayData.workers[w] = `Repos (${rest.days}j)`;
                    workers[w].ongoingRestDays = rest.days - 1;
                    workers[w].nextRestPattern = rest.days;
                    workers[w].totalRestDays++;
                    restGiven++;
                }
                
                const forWork = [];
                for (let w of available) {
                    if (dayData.workers[w] === '') {
                        forWork.push(w);
                    }
                }
                
                forWork.sort((a, b) => workers[a].consecutiveWork - workers[b].consecutiveWork);
                
                const shuffled = [...POSITIONS].sort(() => Math.random() - 0.5);
                const assigned = [];
                
                for (let i = 0; i < 5; i++) {
                    const pos = shuffled[i];
                    const shift = pos.endsWith('-M') ? 'M' : 'S';
                    let found = false;
                    
                    for (let w of forWork) {
                        if (assigned.includes(w)) continue;
                        
                        if (shift === 'M' && workers[w].lastShift === 'S') {
                            if (Math.random() > 0.1) continue;
                        }
                        
                        dayData.workers[w] = pos;
                        workers[w].consecutiveWork++;
                        workers[w].lastShift = shift;
                        
                        if (shift === 'M') {
                            workers[w].consecutiveMorning++;
                            workers[w].consecutiveSoir = 0;
                        } else {
                            workers[w].consecutiveSoir++;
                            workers[w].consecutiveMorning = 0;
                        }
                        
                        assigned.push(w);
                        found = true;
                        break;
                    }
                    
                    if (!found) {
                        for (let w of forWork) {
                            if (assigned.includes(w)) continue;
                            
                            dayData.workers[w] = pos;
                            workers[w].consecutiveWork++;
                            workers[w].lastShift = shift;
                            
                            if (shift === 'M') {
                                workers[w].consecutiveMorning++;
                                workers[w].consecutiveSoir = 0;
                            } else {
                                workers[w].consecutiveSoir++;
                                workers[w].consecutiveMorning = 0;
                            }
                            
                            assigned.push(w);
                            break;
                        }
                    }
                }
                
                let reserveSet = false;
                for (let w of forWork) {
                    if (!assigned.includes(w) && !reserveSet) {
                        dayData.workers[w] = 'R√©serve';
                        workers[w].consecutiveWork++;
                        workers[w].totalReserveDays++;
                        workers[w].lastShift = null;
                        assigned.push(w);
                        reserveSet = true;
                        break;
                    }
                }
                
                for (let w = 0; w < numWorkers; w++) {
                    if (dayData.workers[w] === '') {
                        dayData.workers[w] = 'Repos (1j)';
                        workers[w].totalRestDays++;
                    }
                }
                
                schedule.push(dayData);
            }
            
            return schedule;
        }

        function getMonthName(m) { return ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][m]; }
        function getDayName(y, m, d) { return ['DIM','LUN','MAR','MER','JEU','VEN','SAM'][new Date(y, m, d).getDay()]; }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('roulementData');
                if (saved) return JSON.parse(saved);
            } catch (e) {}
            return { year: 2025, month: 11, numWorkers: 7, schedule: generateSchedule(2025, 11, 7) };
        }

        function App() {
            const initialData = loadFromStorage();
            const [year, setYear] = useState(initialData.year);
            const [month, setMonth] = useState(initialData.month);
            const [numWorkers, setNumWorkers] = useState(initialData.numWorkers);
            const [schedule, setSchedule] = useState(initialData.schedule);
            const [editMode, setEditMode] = useState(false);
            const [selectedCell, setSelectedCell] = useState(null);
            const [showOptions, setShowOptions] = useState(false);
            const [showPeriodModal, setShowPeriodModal] = useState(false);
            const [periodStart, setPeriodStart] = useState('');
            const [periodEnd, setPeriodEnd] = useState('');
            const [time, setTime] = useState(new Date());

            useEffect(() => { const id = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(id); }, []);
            useEffect(() => { localStorage.setItem('roulementData', JSON.stringify({year, month, numWorkers, schedule})); }, [year, month, numWorkers, schedule]);
            useEffect(() => { setSchedule(generateSchedule(year, month, numWorkers)); }, [year, month, numWorkers]);

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const workers = Array.from({length: numWorkers}, (_, i) => `Agent ${i+1}`);
            const options = ['Gare-M','Port-M','Neuf-S','Gare-S','Port-S','R√©serve','Repos (1j)','Repos (2j)','Malade','Cong√©','Formation','Cong√© P√©riode'];

            const addWorker = () => numWorkers < 12 && setNumWorkers(c => c + 1);
            const removeWorker = () => numWorkers > 5 && setNumWorkers(c => c - 1);
            const newSchedule = () => setSchedule(generateSchedule(year, month, numWorkers));

            const downloadJSON = () => {
                const data = {year, month, numWorkers, schedule};
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `oncf-roulement-${year}-${String(month+1).padStart(2,'0')}.json`;
                a.click();
            };

            const uploadJSON = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            setYear(data.year || 2025);
                            setMonth(data.month || 11);
                            setNumWorkers(data.numWorkers || 7);
                            setSchedule(data.schedule || generateSchedule(data.year || 2025, data.month || 11, data.numWorkers || 7));
                        } catch { alert('‚ùå Fichier invalide'); }
                    };
                    reader.readAsText(file);
                }
            };

            const clickCell = (dayIdx, workerIdx) => editMode && (setSelectedCell({dayIdx, workerIdx}), setShowOptions(true));
            
            const applyPeriod = () => {
                if (!selectedCell || !periodStart || !periodEnd) {
                    alert('‚ùå Veuillez remplir les dates');
                    return;
                }
                
                const start = parseInt(periodStart);
                const end = parseInt(periodEnd);
                
                if (start < 1 || end > daysInMonth || start > end) {
                    alert('‚ùå Dates invalides');
                    return;
                }
                
                const newSchedule = schedule.map(day => ({...day, workers: [...day.workers]}));
                
                for (let day = start; day <= end; day++) {
                    const dayIdx = day - 1;
                    const oldValue = newSchedule[dayIdx].workers[selectedCell.workerIdx];
                    
                    if (oldValue.includes('Gare') || oldValue.includes('Port') || oldValue.includes('Neuf')) {
                        for (let w = 0; w < numWorkers; w++) {
                            if (newSchedule[dayIdx].workers[w] === 'R√©serve') {
                                newSchedule[dayIdx].workers[w] = oldValue;
                                break;
                            }
                        }
                    }
                    
                    newSchedule[dayIdx].workers[selectedCell.workerIdx] = 'Cong√©';
                }
                
                setSchedule(newSchedule);
                setShowPeriodModal(false);
                setShowOptions(false);
                setSelectedCell(null);
                setPeriodStart('');
                setPeriodEnd('');
            };
            
            const selectOption = (option) => {
                if (!selectedCell) return;
                
                if (option === 'Cong√© P√©riode') {
                    setShowOptions(false);
                    setShowPeriodModal(true);
                    return;
                }
                
                const newSchedule = schedule.map(day => ({...day, workers: [...day.workers]}));
                const oldValue = newSchedule[selectedCell.dayIdx].workers[selectedCell.workerIdx];
                
                if ((option === 'Malade' || option === 'Cong√©' || option === 'Formation') && 
                    (oldValue.includes('Gare') || oldValue.includes('Port') || oldValue.includes('Neuf'))) {
                    
                    let replaced = false;
                    for (let w = 0; w < numWorkers; w++) {
                        if (newSchedule[selectedCell.dayIdx].workers[w] === 'R√©serve') {
                            newSchedule[selectedCell.dayIdx].workers[w] = oldValue;
                            replaced = true;
                            break;
                        }
                    }
                    
                    if (!replaced) {
                        alert('‚ö†Ô∏è Aucune r√©serve disponible!');
                    }
                }
                
                newSchedule[selectedCell.dayIdx].workers[selectedCell.workerIdx] = option;
                setSchedule(newSchedule);
                setShowOptions(false);
                setSelectedCell(null);
            };

            const getCellStyle = (assignment) => {
                if (!assignment) return 'bg-gradient-to-br from-gray-700 to-gray-800 text-gray-300';
                if (assignment === 'Malade') return 'bg-gradient-to-br from-yellow-500 to-yellow-600 text-yellow-950 font-black shadow-lg';
                if (assignment === 'Formation') return 'bg-gradient-to-br from-purple-500 to-purple-600 text-purple-950 font-black shadow-lg';
                if (assignment.includes('Cong√©')) return 'bg-gradient-to-br from-green-500 to-emerald-600 text-green-950 font-black shadow-lg';
                if (assignment.includes('Repos')) return 'bg-gradient-to-br from-red-600 to-red-700 text-red-50 font-bold shadow-md';
                if (assignment.includes('Gare')) return 'bg-gradient-to-br from-blue-500 to-blue-600 text-blue-950 font-bold shadow-md border border-blue-400';
                if (assignment.includes('Port')) return 'bg-gradient-to-br from-indigo-500 to-indigo-600 text-indigo-950 font-bold shadow-md border border-indigo-400';
                if (assignment.includes('Neuf')) return 'bg-gradient-to-br from-cyan-500 to-cyan-600 text-cyan-950 font-bold shadow-md border border-cyan-400';
                if (assignment === 'R√©serve') return 'bg-gradient-to-br from-orange-500 to-orange-600 text-orange-950 font-black shadow-lg border-2 border-yellow-400';
                return 'bg-gradient-to-br from-gray-600 to-gray-700 text-gray-200';
            };

            const stats = workers.map((_, wIdx) => {
                let restDays = 0, workDays = 0, reserveDays = 0;
                schedule.forEach(day => {
                    const assignment = day.workers[wIdx];
                    if (assignment?.includes('Repos') || assignment?.includes('Cong√©')) {
                        restDays++;
                    } else if (assignment === 'R√©serve') {
                        reserveDays++;
                        workDays++;
                    } else if (assignment && assignment !== 'Malade' && assignment !== 'Formation') {
                        workDays++;
                    }
                });
                return { restDays, workDays, reserveDays };
            });

            let fullCoverage = 0;
            let maxConsecutiveRest = 0;
            let maxReservePerDay = 0;
            
            const dailyCoverage = schedule.map(day => {
                const positions = new Set();
                let reserveCount = 0;
                day.workers.forEach(w => {
                    if (['Gare-M', 'Port-M', 'Neuf-S', 'Gare-S', 'Port-S'].includes(w)) {
                        positions.add(w);
                    }
                    if (w === 'R√©serve') reserveCount++;
                });
                maxReservePerDay = Math.max(maxReservePerDay, reserveCount);
                const covered = positions.size === 5;
                if (covered) fullCoverage++;
                return covered;
            });
            
            workers.forEach((_, wIdx) => {
                let consecutive = 0;
                schedule.forEach(day => {
                    if (day.workers[wIdx]?.includes('Repos')) {
                        consecutive++;
                        maxConsecutiveRest = Math.max(maxConsecutiveRest, consecutive);
                    } else {
                        consecutive = 0;
                    }
                });
            });

            return e('div', {className: 'space-y-8 max-w-[96%] mx-auto animate-fadeIn'},
                // Header ONCF
                e('div', {className: 'oncf-header rounded-[28px] p-10 shadow-2xl animate-slideIn'},
                    e('div', {className: 'flex flex-col lg:flex-row items-center justify-between gap-6'},
                        e('div', {className: 'flex items-center gap-6'},
                            e('div', {className: 'text-8xl animate-pulse-slow'}, 'üöÑ'),
                            e('div', null,
                                e('h1', {className: 'text-7xl font-black text-yellow-400 oncf-logo mb-2'}, 'ONCF'),
                                e('p', {className: 'text-2xl text-yellow-200 font-bold tracking-wide'}, 'Syst√®me de Gestion des Roulements'),
                                e('div', {className: 'flex items-center gap-3 mt-2'},
                                    e('span', {className: 'station-indicator'}),
                                    e('span', {className: 'text-green-400 font-bold text-lg'}, 'SYST√àME ACTIF')
                                )
                            )
                        ),
                        e('div', {className: 'flex flex-col gap-3'},
                            e('div', {className: 'px-10 py-5 bg-slate-900 text-yellow-400 rounded-2xl font-black text-2xl text-center shadow-2xl border-2 border-yellow-500'}, `${getMonthName(month)} ${year}`),
                            e('div', {className: 'px-10 py-5 bg-slate-900 text-emerald-400 rounded-2xl font-mono font-black text-2xl text-center shadow-2xl border-2 border-emerald-500'}, time.toLocaleTimeString('fr-FR'))
                        )
                    ),
                    e('div', {className: 'mt-8 flex flex-wrap items-center justify-center gap-4'},
                        e('div', {className: 'flex items-center gap-3 glass-effect px-8 py-5 rounded-2xl shadow-2xl'},
                            e('span', {className: 'text-yellow-400 text-xl mr-2'}, 'üìÖ'),
                            e('select',{value:month,onChange:ev=>setMonth(Number(ev.target.value)),className:'px-6 py-4 bg-slate-900 text-yellow-400 border-2 border-yellow-500 rounded-xl text-lg font-bold focus:ring-4 focus:ring-yellow-500'},Array.from({length:12},(_,i)=>e('option',{key:i,value:i},getMonthName(i)))),
                            e('input',{type:'number',value:year,onChange:ev=>setYear(Number(ev.target.value)),className:'w-28 px-6 py-4 bg-slate-900 text-yellow-400 border-2 border-yellow-500 rounded-xl text-lg font-bold text-center focus:ring-4 focus:ring-yellow-500',min:2020,max:2030})
                        ),
                        e('div',{className:'flex items-center gap-3 glass-effect px-8 py-5 rounded-2xl shadow-2xl'},
                            e('span', {className: 'text-yellow-400 text-xl mr-2'}, 'üë•'),
                            e('button',{onClick:removeWorker,className:'w-16 h-16 bg-gradient-to-br from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-xl font-black text-3xl btn-oncf shadow-2xl'},'‚àí'),
                            e('span',{className:'w-20 text-center font-black text-4xl text-yellow-400'},numWorkers),
                            e('button',{onClick:addWorker,className:'w-16 h-16 bg-gradient-to-br from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-xl font-black text-3xl btn-oncf shadow-2xl'},'+')
                        ),
                        e('button',{onClick:newSchedule,className:'bg-gradient-to-r from-emerald-600 to-teal-700 text-white px-12 py-5 rounded-2xl font-black text-xl btn-oncf shadow-2xl'},'üîÑ G√©n√©rer'),
                        e('label',{htmlFor:'upload',className:'bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-12 py-5 rounded-2xl font-black text-xl btn-oncf shadow-2xl cursor-pointer'},'üì• Importer',e('input',{type:'file',id:'upload',accept:'.json',onChange:uploadJSON,className:'hidden'})),
                        e('button',{onClick:downloadJSON,className:'bg-gradient-to-r from-purple-600 to-pink-700 text-white px-12 py-5 rounded-2xl font-black text-xl btn-oncf shadow-2xl'},'üíæ Exporter'),
                        e('button',{onClick:()=>setEditMode(!editMode),className:`px-12 py-5 rounded-2xl font-black text-xl btn-oncf shadow-2xl ${editMode?'bg-gradient-to-r from-red-600 to-pink-700 text-white':'bg-gradient-to-r from-amber-600 to-orange-700 text-white'}`},editMode?'‚ùå Fermer':'‚úèÔ∏è Modifier')
                    )
                ),

                // Table
                e('div',{className:'scroll-container glass-effect'},
                    e('table',{className:'table-container'},
                        e('thead',null,
                            e('tr',null,
                                e('th',{className:'th-worker'},'üöÇ AGENT'),
                                Array.from({length:daysInMonth},(_,i)=>e('th',{key:i,className:`day-cell ${dailyCoverage[i] ? 'bg-gradient-to-b from-emerald-800 to-emerald-900' : 'bg-gradient-to-b from-red-800 to-red-900'}`},e('div',{className:'text-xl font-black'},i+1),e('div',{className:'text-[9px] font-bold tracking-widest'},getDayName(year,month,i+1)))),
                                e('th',{className:'th-total'},'üìä REPOS')
                            )
                        ),
                        e('tbody',null,
                            workers.map((worker,wIdx)=>
                                e('tr',{key:wIdx,className:'border-b border-red-900/30 hover:bg-slate-800/50 transition-all'},
                                    e('td',{className:'td-worker'},e('div',{className:'font-black text-base flex items-center justify-center gap-2'},e('span',null,'üë§'),worker)),
                                    schedule.map((day,dIdx)=>{
                                        const assignment = day.workers[wIdx];
                                        return e('td',{
                                            key:dIdx,
                                            className:`day-cell ${editMode ? 'cell-hover' : ''} ${getCellStyle(assignment)} transition-all`,
                                            onClick:()=>clickCell(dIdx,wIdx)
                                        },e('div',{className:'text-[10px] leading-tight font-extrabold'},assignment||'‚Äî'));
                                    }),
                                    e('td',{className:'td-total'},e('div',{className:'text-2xl font-black'},`${stats[wIdx].restDays}j`))
                                )
                            )
                        )
                    )
                ),

                // Modal Options
                showOptions && e('div',{className:'fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[1000] animate-fadeIn',onClick:()=>{setShowOptions(false);setSelectedCell(null);}},
                    e('div',{className:'glass-effect p-12 rounded-3xl shadow-2xl border-4 border-red-600 max-w-2xl w-full animate-slideIn',onClick:ev=>ev.stopPropagation()},
                        e('h3',{className:'text-5xl font-black text-center mb-10 text-yellow-400 oncf-logo'},'üéØ MODIFIER AFFECTATION'),
                        e('div',{className:'grid grid-cols-2 gap-5'},
                            options.map(opt=>e('button',{
                                key:opt,
                                onClick:()=>selectOption(opt),
                                className:`p-8 ${opt === 'Cong√© P√©riode' ? 'col-span-2 bg-gradient-to-r from-green-600 to-emerald-700' : 'bg-gradient-to-br from-slate-700 to-slate-800'} hover:scale-105 text-white rounded-2xl border-3 border-yellow-500 font-black text-lg shadow-2xl transition-all btn-oncf`
                            },opt === 'Cong√© P√©riode' ? 'üìÖ Cong√© (P√©riode)' : opt))
                        ),
                        e('button',{onClick:()=>{setShowOptions(false);setSelectedCell(null);},className:'w-full mt-10 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-6 rounded-2xl font-black text-2xl btn-oncf shadow-2xl'},'‚ùå ANNULER')
                    )
                ),

                // Modal Period
                showPeriodModal && e('div',{className:'fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[1100] animate-fadeIn',onClick:()=>{setShowPeriodModal(false);setPeriodStart('');setPeriodEnd('');}},
                    e('div',{className:'glass-effect p-14 rounded-3xl shadow-2xl border-4 border-emerald-600 max-w-2xl w-full animate-slideIn',onClick:ev=>ev.stopPropagation()},
                        e('h3',{className:'text-5xl font-black text-center mb-12 text-yellow-400 oncf-logo'},'üìÖ P√âRIODE DE CONG√â'),
                        e('div',{className:'space-y-10'},
                            e('div',{className:'space-y-4'},
                                e('label',{className:'block text-2xl font-black text-yellow-400 flex items-center gap-3'},e('span',null,'üö©'),'DU JOUR:'),
                                e('input',{type:'number',value:periodStart,onChange:ev=>setPeriodStart(ev.target.value),min:1,max:daysInMonth,placeholder:'1',className:'w-full px-10 py-6 text-4xl font-black text-center bg-slate-900 text-yellow-400 border-4 border-yellow-500 rounded-2xl focus:ring-6 focus:ring-yellow-500 shadow-2xl'})
                            ),
                            e('div',{className:'text-center text-5xl font-black text-red-600'},'‚¨á'),
                            e('div',{className:'space-y-4'},
                                e('label',{className:'block text-2xl font-black text-yellow-400 flex items-center gap-3'},e('span',null,'üèÅ'),'AU JOUR:'),
                                e('input',{type:'number',value:periodEnd,onChange:ev=>setPeriodEnd(ev.target.value),min:1,max:daysInMonth,placeholder:daysInMonth,className:'w-full px-10 py-6 text-4xl font-black text-center bg-slate-900 text-yellow-400 border-4 border-yellow-500 rounded-2xl focus:ring-6 focus:ring-yellow-500 shadow-2xl'})
                            )
                        ),
                        e('div',{className:'flex gap-6 mt-12'},
                            e('button',{onClick:applyPeriod,className:'flex-1 bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-700 hover:to-teal-800 text-white py-7 rounded-2xl font-black text-2xl btn-oncf shadow-2xl'},'‚úÖ APPLIQUER'),
                            e('button',{onClick:()=>{setShowPeriodModal(false);setPeriodStart('');setPeriodEnd('');},className:'flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-7 rounded-2xl font-black text-2xl btn-oncf shadow-2xl'},'‚ùå ANNULER')
                        )
                    )
                ),

                // Statistics
                e('div',{className:'glass-effect p-12 rounded-3xl border-4 border-red-600 shadow-2xl animate-fadeIn'},
                    e('h3',{className:'text-5xl font-black text-center mb-10 text-yellow-400 oncf-logo flex items-center justify-center gap-4'},e('span',null,'üìä'),'STATISTIQUES MENSUELLES',e('span',null,'üöÑ')),
                    e('div',{className:'grid grid-cols-1 md:grid-cols-3 gap-6 mb-10'},
                        fullCoverage === daysInMonth ? 
                            e('div',{className:'badge-success text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'üéâ'),
                                e('div',{className:'text-3xl font-black'},'COUVERTURE'),
                                e('div',{className:'text-5xl font-black mt-3'},'100%'),
                                e('div',{className:'text-lg mt-2 opacity-90'},'Toutes gares op√©rationnelles')
                            )
                        :
                            e('div',{className:'badge-error text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'‚ö†Ô∏è'),
                                e('div',{className:'text-3xl font-black'},'ALERTE'),
                                e('div',{className:'text-4xl font-black mt-3'},`${fullCoverage}/${daysInMonth}`),
                                e('div',{className:'text-lg mt-2 opacity-90'},'Gares non couvertes')
                            ),
                        maxConsecutiveRest <= 2 ?
                            e('div',{className:'badge-success text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'‚úÖ'),
                                e('div',{className:'text-3xl font-black'},'REPOS MAX'),
                                e('div',{className:'text-5xl font-black mt-3'},'2 JOURS'),
                                e('div',{className:'text-lg mt-2 opacity-90'},'Conformit√© respect√©e')
                            )
                        :
                            e('div',{className:'badge-error text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'‚ùå'),
                                e('div',{className:'text-3xl font-black'},'ERREUR'),
                                e('div',{className:'text-4xl font-black mt-3'},`${maxConsecutiveRest} JOURS`),
                                e('div',{className:'text-lg mt-2 opacity-90'},'D√©passement d√©tect√©')
                            ),
                        maxReservePerDay <= 1 ?
                            e('div',{className:'badge-success text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'üî∂'),
                                e('div',{className:'text-3xl font-black'},'R√âSERVE'),
                                e('div',{className:'text-5xl font-black mt-3'},'1 AGENT'),
                                e('div',{className:'text-lg mt-2 opacity-90'},'Quota optimal')
                            )
                        :
                            e('div',{className:'badge-error text-white p-10 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-6xl mb-3'},'‚ùå'),
                                e('div',{className:'text-3xl font-black'},'SURCHARGE'),
                                e('div',{className:'text-4xl font-black mt-3'},`${maxReservePerDay} AGENTS`),
                                e('div',{className:'text-lg mt-2 opacity-90'},'R√©serves exc√©dentaires')
                            )
                    ),
                    e('div',{className:'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6'},
                        stats.map((stat, i) =>
                            e('div',{key:i,className:'stat-card text-white p-10 rounded-2xl shadow-2xl text-center border-2 border-yellow-600'},
                                e('div',{className:'text-5xl mb-4'},'üöÇ'),
                                e('div',{className:'font-black text-4xl mb-5 text-yellow-400'},`Agent ${i+1}`),
                                e('div',{className:'text-6xl font-black mb-3 text-emerald-400'},`${stat.workDays}`),
                                e('div',{className:'text-base font-bold mb-5 opacity-90'},'jours travail'),
                                e('div',{className:'text-4xl font-black text-orange-400 mb-2'},`${stat.reserveDays}`),
                                e('div',{className:'text-sm font-bold mb-5 opacity-80'},'r√©serves'),
                                e('div',{className:'text-4xl font-black text-red-400'},`${stat.restDays}`),
                                e('div',{className:'text-sm font-bold opacity-80'},'jours repos')
                            )
                        )
                    )
                ),

                // Footer
                e('div',{className:'text-center text-yellow-400 font-bold text-lg py-6 glass-effect rounded-2xl'},
                    e('div',{className:'flex items-center justify-center gap-3 mb-2'},
                        e('span',{className:'text-3xl'},'üöÑ'),
                        e('span',{className:'oncf-logo text-2xl'},'ONCF - Office National des Chemins de Fer'),
                        e('span',{className:'text-3xl'},'üöÑ')
                    ),
                    e('div',{className:'text-sm opacity-75'},'Syst√®me de Gestion Intelligente des Roulements Ferroviaires')
                )
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
</body>
</html>
