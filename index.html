<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ Roulement Pro - SystÃ¨me Complet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&display=swap');
        
        * { 
            scrollbar-width: thin; 
            scrollbar-color: #6366f1 #f1f5f9;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.5s ease-out; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .scroll-container { 
            height: 65vh; 
            overflow: auto !important; 
            border-radius: 24px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            border: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .scroll-container::-webkit-scrollbar { width: 16px; height: 16px; }
        .scroll-container::-webkit-scrollbar-track { 
            background: linear-gradient(to bottom, #f1f5f9, #e2e8f0); 
            border-radius: 16px; 
        }
        .scroll-container::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            border-radius: 16px; 
            border: 3px solid #f1f5f9;
            transition: all 0.3s;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
        }
        
        .table-container { 
            table-layout: fixed; 
            width: 100%; 
            min-width: 2200px; 
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th, td { 
            padding: 14px 8px; 
            text-align: center; 
            border-right: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        th { 
            position: sticky !important; 
            top: 0 !important; 
            z-index: 100 !important; 
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%) !important; 
            color: white !important; 
            font-weight: 800 !important; 
            font-size: 13px !important; 
            height: 50px !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }
        
        .th-worker { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 120 !important; 
            background: linear-gradient(135deg, #3b82f6, #6366f1, #8b5cf6) !important; 
            width: 120px !important;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);
        }
        
        .th-total { 
            position: sticky !important; 
            right: 0 !important; 
            z-index: 120 !important; 
            background: linear-gradient(135deg, #10b981, #059669, #047857) !important; 
            width: 80px !important;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
        }
        
        .day-cell { width: 60px !important; min-width: 60px !important; }
        
        td { 
            font-size: 12px; 
            font-weight: 700; 
            height: 48px; 
            vertical-align: middle;
        }
        
        .td-worker { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 90 !important; 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe, #93c5fd) !important; 
            width: 120px !important; 
            font-weight: 900 !important; 
            font-size: 13px !important;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1);
        }
        
        .td-total { 
            position: sticky !important; 
            right: 0 !important; 
            z-index: 90 !important; 
            background: linear-gradient(135deg, #d1fae5, #a7f3d0, #6ee7b7) !important; 
            width: 80px !important; 
            font-weight: 900 !important; 
            font-size: 15px !important;
            box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
        }
        
        .cell-hover:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 50;
            cursor: pointer;
        }
        
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }
        
        .btn-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.4s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .badge-success {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: pulse 2s infinite;
        }
        
        .badge-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <div id="root"></div>

    <script type="text/javascript">
        const { useState, useEffect } = React;
        const e = React.createElement;

        // âœ… Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØµØ­Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        function generateSchedule(year, month, numWorkers) {
            const schedule = [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const POSITIONS = ['Gare-M', 'Port-M', 'Neuf-S', 'Gare-S', 'Port-S'];
            
            const workers = Array.from({length: numWorkers}, () => ({
                consecutiveWork: 0,      // Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© (ÙŠØ´Ù…Ù„ Ø§Ø­ØªÙŠØ§Ø·)
                consecutiveMorning: 0,   // Ø£ÙŠØ§Ù… Ø§Ù„ØµØ¨Ø§Ø­ Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
                consecutiveSoir: 0,      // Ø£ÙŠØ§Ù… Ø§Ù„Ø²ÙˆØ§Ù„ Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
                lastShift: null,         // M Ø£Ùˆ S Ø£Ùˆ null (Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·)
                nextRestPattern: 1,      // 1j Ø£Ùˆ 2j
                ongoingRestDays: 0,      // Ø£ÙŠØ§Ù… Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                totalRestDays: 0,
                totalReserveDays: 0
            }));
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = { date: day, workers: Array(numWorkers).fill('') };
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù† ÙÙŠ Ø±Ø§Ø­Ø© Ù…Ø³ØªÙ…Ø±Ø©
                const inRest = [];
                for (let w = 0; w < numWorkers; w++) {
                    if (workers[w].ongoingRestDays > 0) {
                        dayData.workers[w] = `Repos (${workers[w].nextRestPattern}j)`;
                        workers[w].ongoingRestDays--;
                        workers[w].totalRestDays++;
                        inRest.push(w);
                        
                        // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø§Ø­Ø©
                        if (workers[w].ongoingRestDays === 0) {
                            workers[w].consecutiveWork = 0;
                            workers[w].consecutiveMorning = 0;
                            workers[w].consecutiveSoir = 0;
                            workers[w].lastShift = null;
                            // ØªØ¨Ø¯ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„Ø±Ø§Ø­Ø©: 1â†’2 Ø£Ùˆ 2â†’1
                            workers[w].nextRestPattern = workers[w].nextRestPattern === 1 ? 2 : 1;
                        }
                    }
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¬Ù…Ø¹ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† (Ù„ÙŠØ³ÙˆØ§ ÙÙŠ Ø±Ø§Ø­Ø©)
                const available = [];
                for (let w = 0; w < numWorkers; w++) {
                    if (!inRest.includes(w)) {
                        available.push(w);
                    }
                }
                
                // Ø¥Ø°Ø§ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† < 6 (5 Ù…Ø±Ø§ÙƒØ² + 1 Ø§Ø­ØªÙŠØ§Ø·)ØŒ Ù„Ø§ Ù†Ø¹Ø·ÙŠ Ø±Ø§Ø­Ø© Ø¬Ø¯ÙŠØ¯Ø©
                if (available.length < 6) {
                    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
                    available.sort((a, b) => workers[a].consecutiveWork - workers[b].consecutiveWork);
                    const shuffled = [...POSITIONS].sort(() => Math.random() - 0.5);
                    
                    for (let i = 0; i < Math.min(5, available.length); i++) {
                        const w = available[i];
                        const pos = shuffled[i];
                        const shift = pos.endsWith('-M') ? 'M' : 'S';
                        
                        dayData.workers[w] = pos;
                        workers[w].consecutiveWork++;
                        workers[w].lastShift = shift;
                        
                        if (shift === 'M') {
                            workers[w].consecutiveMorning++;
                            workers[w].consecutiveSoir = 0;
                        } else {
                            workers[w].consecutiveSoir++;
                            workers[w].consecutiveMorning = 0;
                        }
                    }
                    
                    // Ø§Ø­ØªÙŠØ§Ø· ÙˆØ§Ø­Ø¯ Ø¥Ù† ÙˆÙØ¬Ø¯
                    if (available.length > 5) {
                        const w = available[5];
                        dayData.workers[w] = 'RÃ©serve';
                        workers[w].consecutiveWork++;
                        workers[w].totalReserveDays++;
                        workers[w].lastShift = null;
                    }
                    
                    // Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø±Ø§Ø­Ø©
                    for (let w = 0; w < numWorkers; w++) {
                        if (dayData.workers[w] === '') {
                            dayData.workers[w] = 'Repos (1j)';
                            workers[w].totalRestDays++;
                        }
                    }
                    
                    schedule.push(dayData);
                    continue;
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ­Ø¯ÙŠØ¯ Ù…Ù† ÙŠØ­ØªØ§Ø¬ Ø±Ø§Ø­Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
                const mustRest = [];
                for (let w of available) {
                    let needRest = false;
                    let restDays = 1;
                    
                    // Ù‚Ø§Ø¹Ø¯Ø© 1: 5 Ø£ÙŠØ§Ù… ØµØ¨Ø§Ø­ Ù…ØªØªØ§Ù„ÙŠØ© â†’ Ø±Ø§Ø­Ø© 2j
                    if (workers[w].consecutiveMorning >= 5) {
                        needRest = true;
                        restDays = 2;
                    }
                    // Ù‚Ø§Ø¹Ø¯Ø© 2: 5 Ø£ÙŠØ§Ù… Ø²ÙˆØ§Ù„ Ù…ØªØªØ§Ù„ÙŠØ© â†’ Ø±Ø§Ø­Ø© 1j
                    else if (workers[w].consecutiveSoir >= 5) {
                        needRest = true;
                        restDays = 1;
                    }
                    // Ù‚Ø§Ø¹Ø¯Ø© 3: 6 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ â†’ Ø±Ø§Ø­Ø© 2j (Ø¶Ø±ÙˆØ±Ø© Ù‚ØµÙˆÙ‰)
                    else if (workers[w].consecutiveWork >= 6) {
                        needRest = true;
                        restDays = 2;
                    }
                    // Ù‚Ø§Ø¹Ø¯Ø© 4: 5 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ â†’ Ø±Ø§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Ù…Ø·
                    else if (workers[w].consecutiveWork >= 5) {
                        needRest = true;
                        restDays = workers[w].nextRestPattern;
                    }
                    
                    if (needRest) {
                        mustRest.push({worker: w, days: restDays});
                    }
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø¥Ø¹Ø·Ø§Ø¡ Ø±Ø§Ø­Ø© (Ø¨Ø´Ø±Ø· Ø¨Ù‚Ø§Ø¡ 6 Ø¹Ù…Ø§Ù„)
                let restGiven = 0;
                for (let rest of mustRest) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù‚Ø§Ø¡ 6 Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                    if (available.length - restGiven <= 6) break;
                    
                    const w = rest.worker;
                    dayData.workers[w] = `Repos (${rest.days}j)`;
                    workers[w].ongoingRestDays = rest.days - 1; // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ ÙŠÙØ­Ø³Ø¨ Ø§Ù„Ø¢Ù†
                    workers[w].nextRestPattern = rest.days;
                    workers[w].totalRestDays++;
                    restGiven++;
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ø¹Ù…Ù„
                const forWork = [];
                for (let w of available) {
                    if (dayData.workers[w] === '') {
                        forWork.push(w);
                    }
                }
                
                // ØªØ±ØªÙŠØ¨: Ù…Ù† Ø¹Ù…Ù„ Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹
                forWork.sort((a, b) => workers[a].consecutiveWork - workers[b].consecutiveWork);
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø®Ù…Ø³Ø©
                const shuffled = [...POSITIONS].sort(() => Math.random() - 0.5);
                const assigned = [];
                
                for (let i = 0; i < 5; i++) {
                    const pos = shuffled[i];
                    const shift = pos.endsWith('-M') ? 'M' : 'S';
                    let found = false;
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø­ØªØ±Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø©: Ù„Ø§ ØµØ¨Ø§Ø­ Ø¨Ø¹Ø¯ Ø²ÙˆØ§Ù„
                    for (let w of forWork) {
                        if (assigned.includes(w)) continue;
                        
                        // Ù‚Ø§Ø¹Ø¯Ø©: Ù„Ø§ ØµØ¨Ø§Ø­ Ø¨Ø¹Ø¯ Ø²ÙˆØ§Ù„ (90% Ø§Ø­ØªØ±Ø§Ù…)
                        if (shift === 'M' && workers[w].lastShift === 'S') {
                            if (Math.random() > 0.1) continue; // 10% Ù„Ù„Ø¶Ø±ÙˆØ±Ø© ÙÙ‚Ø·
                        }
                        
                        // ØªØ¹ÙŠÙŠÙ†
                        dayData.workers[w] = pos;
                        workers[w].consecutiveWork++;
                        workers[w].lastShift = shift;
                        
                        if (shift === 'M') {
                            workers[w].consecutiveMorning++;
                            workers[w].consecutiveSoir = 0;
                        } else {
                            workers[w].consecutiveSoir++;
                            workers[w].consecutiveMorning = 0;
                        }
                        
                        assigned.push(w);
                        found = true;
                        break;
                    }
                    
                    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙŠ Ø¹Ø§Ù…Ù„ (Ø¶Ø±ÙˆØ±Ø© Ù‚ØµÙˆÙ‰)
                    if (!found) {
                        for (let w of forWork) {
                            if (assigned.includes(w)) continue;
                            
                            dayData.workers[w] = pos;
                            workers[w].consecutiveWork++;
                            workers[w].lastShift = shift;
                            
                            if (shift === 'M') {
                                workers[w].consecutiveMorning++;
                                workers[w].consecutiveSoir = 0;
                            } else {
                                workers[w].consecutiveSoir++;
                                workers[w].consecutiveMorning = 0;
                            }
                            
                            assigned.push(w);
                            break;
                        }
                    }
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: Ø§Ø­ØªÙŠØ§Ø· ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                let reserveSet = false;
                for (let w of forWork) {
                    if (!assigned.includes(w) && !reserveSet) {
                        dayData.workers[w] = 'RÃ©serve';
                        workers[w].consecutiveWork++; // Ø§Ø­ØªÙŠØ§Ø· = ÙŠÙˆÙ… Ø¹Ù…Ù„
                        workers[w].totalReserveDays++;
                        workers[w].lastShift = null; // Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© ØµØ¨Ø§Ø­/Ø²ÙˆØ§Ù„
                        assigned.push(w);
                        reserveSet = true;
                        break;
                    }
                }
                
                // âœ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8: Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø±Ø§Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                for (let w = 0; w < numWorkers; w++) {
                    if (dayData.workers[w] === '') {
                        dayData.workers[w] = 'Repos (1j)';
                        workers[w].totalRestDays++;
                    }
                }
                
                schedule.push(dayData);
            }
            
            return schedule;
        }

        function getMonthName(m) { return ['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'][m]; }
        function getDayName(y, m, d) { return ['DIM','LUN','MAR','MER','JEU','VEN','SAM'][new Date(y, m, d).getDay()]; }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('roulementData');
                if (saved) return JSON.parse(saved);
            } catch (e) {}
            return { year: 2025, month: 11, numWorkers: 7, schedule: generateSchedule(2025, 11, 7) };
        }

        function App() {
            const initialData = loadFromStorage();
            const [year, setYear] = useState(initialData.year);
            const [month, setMonth] = useState(initialData.month);
            const [numWorkers, setNumWorkers] = useState(initialData.numWorkers);
            const [schedule, setSchedule] = useState(initialData.schedule);
            const [editMode, setEditMode] = useState(false);
            const [selectedCell, setSelectedCell] = useState(null);
            const [showOptions, setShowOptions] = useState(false);
            const [showPeriodModal, setShowPeriodModal] = useState(false);
            const [periodStart, setPeriodStart] = useState('');
            const [periodEnd, setPeriodEnd] = useState('');
            const [time, setTime] = useState(new Date());

            useEffect(() => { const id = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(id); }, []);
            useEffect(() => { localStorage.setItem('roulementData', JSON.stringify({year, month, numWorkers, schedule})); }, [year, month, numWorkers, schedule]);
            useEffect(() => { setSchedule(generateSchedule(year, month, numWorkers)); }, [year, month, numWorkers]);

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const workers = Array.from({length: numWorkers}, (_, i) => `Ouvrier ${i+1}`);
            const options = ['Gare-M','Port-M','Neuf-S','Gare-S','Port-S','RÃ©serve','Repos (1j)','Repos (2j)','Malade','CongÃ©','Formation','CongÃ© PÃ©riode'];

            const addWorker = () => numWorkers < 12 && setNumWorkers(c => c + 1);
            const removeWorker = () => numWorkers > 5 && setNumWorkers(c => c - 1);
            const newSchedule = () => setSchedule(generateSchedule(year, month, numWorkers));

            const downloadJSON = () => {
                const data = {year, month, numWorkers, schedule};
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `roulement-${year}-${String(month+1).padStart(2,'0')}.json`;
                a.click();
            };

            const uploadJSON = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            setYear(data.year || 2025);
                            setMonth(data.month || 11);
                            setNumWorkers(data.numWorkers || 7);
                            setSchedule(data.schedule || generateSchedule(data.year || 2025, data.month || 11, data.numWorkers || 7));
                        } catch { alert('âŒ Fichier invalide'); }
                    };
                    reader.readAsText(file);
                }
            };

            const clickCell = (dayIdx, workerIdx) => editMode && (setSelectedCell({dayIdx, workerIdx}), setShowOptions(true));
            
            const applyPeriod = () => {
                if (!selectedCell || !periodStart || !periodEnd) {
                    alert('âŒ Veuillez remplir les dates');
                    return;
                }
                
                const start = parseInt(periodStart);
                const end = parseInt(periodEnd);
                
                if (start < 1 || end > daysInMonth || start > end) {
                    alert('âŒ Dates invalides');
                    return;
                }
                
                const newSchedule = schedule.map(day => ({...day, workers: [...day.workers]}));
                
                for (let day = start; day <= end; day++) {
                    const dayIdx = day - 1;
                    const oldValue = newSchedule[dayIdx].workers[selectedCell.workerIdx];
                    
                    if (oldValue.includes('Gare') || oldValue.includes('Port') || oldValue.includes('Neuf')) {
                        for (let w = 0; w < numWorkers; w++) {
                            if (newSchedule[dayIdx].workers[w] === 'RÃ©serve') {
                                newSchedule[dayIdx].workers[w] = oldValue;
                                break;
                            }
                        }
                    }
                    
                    newSchedule[dayIdx].workers[selectedCell.workerIdx] = 'CongÃ©';
                }
                
                setSchedule(newSchedule);
                setShowPeriodModal(false);
                setShowOptions(false);
                setSelectedCell(null);
                setPeriodStart('');
                setPeriodEnd('');
            };
            
            const selectOption = (option) => {
                if (!selectedCell) return;
                
                if (option === 'CongÃ© PÃ©riode') {
                    setShowOptions(false);
                    setShowPeriodModal(true);
                    return;
                }
                
                const newSchedule = schedule.map(day => ({...day, workers: [...day.workers]}));
                const oldValue = newSchedule[selectedCell.dayIdx].workers[selectedCell.workerIdx];
                
                if ((option === 'Malade' || option === 'CongÃ©' || option === 'Formation') && 
                    (oldValue.includes('Gare') || oldValue.includes('Port') || oldValue.includes('Neuf'))) {
                    
                    let replaced = false;
                    for (let w = 0; w < numWorkers; w++) {
                        if (newSchedule[selectedCell.dayIdx].workers[w] === 'RÃ©serve') {
                            newSchedule[selectedCell.dayIdx].workers[w] = oldValue;
                            replaced = true;
                            break;
                        }
                    }
                    
                    if (!replaced) {
                        alert('âš ï¸ Aucune rÃ©serve disponible!');
                    }
                }
                
                newSchedule[selectedCell.dayIdx].workers[selectedCell.workerIdx] = option;
                setSchedule(newSchedule);
                setShowOptions(false);
                setSelectedCell(null);
            };

            const getCellStyle = (assignment) => {
                if (!assignment) return 'bg-gradient-to-br from-gray-200 to-gray-300 text-gray-700';
                if (assignment === 'Malade') return 'bg-gradient-to-br from-yellow-300 to-yellow-400 text-yellow-900 font-black shadow-lg';
                if (assignment === 'Formation') return 'bg-gradient-to-br from-pink-300 to-pink-400 text-pink-900 font-black shadow-lg';
                if (assignment.includes('CongÃ©')) return 'bg-gradient-to-br from-lime-300 to-emerald-400 text-emerald-900 font-black shadow-lg';
                if (assignment.includes('Repos')) return 'bg-gradient-to-br from-red-300 to-red-400 text-red-900 font-bold shadow-md';
                if (assignment.includes('Gare')) return 'bg-gradient-to-br from-blue-300 to-blue-400 text-blue-900 font-bold shadow-md';
                if (assignment.includes('Port')) return 'bg-gradient-to-br from-purple-300 to-purple-400 text-purple-900 font-bold shadow-md';
                if (assignment.includes('Neuf')) return 'bg-gradient-to-br from-cyan-300 to-cyan-400 text-cyan-900 font-bold shadow-md';
                if (assignment === 'RÃ©serve') return 'bg-gradient-to-br from-orange-300 to-orange-400 text-orange-900 font-black shadow-lg';
                return 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-800';
            };

            const stats = workers.map((_, wIdx) => {
                let restDays = 0, workDays = 0, reserveDays = 0;
                schedule.forEach(day => {
                    const assignment = day.workers[wIdx];
                    if (assignment?.includes('Repos') || assignment?.includes('CongÃ©')) {
                        restDays++;
                    } else if (assignment === 'RÃ©serve') {
                        reserveDays++;
                        workDays++;
                    } else if (assignment && assignment !== 'Malade' && assignment !== 'Formation') {
                        workDays++;
                    }
                });
                return { restDays, workDays, reserveDays };
            });

            let fullCoverage = 0;
            let maxConsecutiveRest = 0;
            let maxReservePerDay = 0;
            
            const dailyCoverage = schedule.map(day => {
                const positions = new Set();
                let reserveCount = 0;
                day.workers.forEach(w => {
                    if (['Gare-M', 'Port-M', 'Neuf-S', 'Gare-S', 'Port-S'].includes(w)) {
                        positions.add(w);
                    }
                    if (w === 'RÃ©serve') reserveCount++;
                });
                maxReservePerDay = Math.max(maxReservePerDay, reserveCount);
                const covered = positions.size === 5;
                if (covered) fullCoverage++;
                return covered;
            });
            
            workers.forEach((_, wIdx) => {
                let consecutive = 0;
                schedule.forEach(day => {
                    if (day.workers[wIdx]?.includes('Repos')) {
                        consecutive++;
                        maxConsecutiveRest = Math.max(maxConsecutiveRest, consecutive);
                    } else {
                        consecutive = 0;
                    }
                });
            });

            return e('div', {className: 'space-y-8 max-w-[95%] mx-auto animate-fadeIn'},
                e('div', {className: 'glass-effect rounded-[32px] p-10 border-4 border-white/40 shadow-2xl animate-slideIn'},
                    e('div', {className: 'flex flex-col lg:flex-row items-center justify-between gap-8'},
                        e('div', {className: 'flex items-center gap-6'},
                            e('div', {className: 'text-7xl animate-pulse-slow'}, 'ğŸŒŸ'),
                            e('div', null,
                                e('h1', {className: 'text-6xl font-black bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-2'}, 'Roulement Pro'),
                                e('p', {className: 'text-lg text-gray-600 font-semibold'}, 'Gestion Intelligente & Ã‰lÃ©gante')
                            )
                        ),
                        e('div', {className: 'flex flex-col gap-3'},
                            e('div', {className: 'px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-black text-xl text-center shadow-xl'}, `${getMonthName(month)} ${year}`),
                            e('div', {className: 'px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-2xl font-mono font-bold text-xl text-center shadow-xl'}, time.toLocaleTimeString('fr-FR'))
                        )
                    ),
                    e('div', {className: 'mt-8 flex flex-wrap items-center justify-center gap-4'},
                        e('div', {className: 'flex items-center gap-3 glass-effect px-6 py-4 rounded-2xl shadow-lg'},
                            e('select',{value:month,onChange:ev=>setMonth(Number(ev.target.value)),className:'px-6 py-3 bg-white/80 border-2 border-indigo-300 rounded-xl text-lg font-bold focus:ring-4 focus:ring-indigo-400'},Array.from({length:12},(_,i)=>e('option',{key:i,value:i},getMonthName(i)))),
                            e('input',{type:'number',value:year,onChange:ev=>setYear(Number(ev.target.value)),className:'w-28 px-6 py-3 bg-white/80 border-2 border-indigo-300 rounded-xl text-lg font-bold text-center focus:ring-4 focus:ring-indigo-400',min:2020,max:2030})
                        ),
                        e('div',{className:'flex items-center gap-3 glass-effect px-6 py-4 rounded-2xl shadow-lg'},
                            e('button',{onClick:removeWorker,className:'w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-black text-2xl btn-modern shadow-lg'},'âˆ’'),
                            e('span',{className:'w-16 text-center font-black text-3xl bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent'},numWorkers),
                            e('button',{onClick:addWorker,className:'w-14 h-14 bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl font-black text-2xl btn-modern shadow-lg'},'+')
                        ),
                        e('button',{onClick:newSchedule,className:'bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-600 text-white px-10 py-4 rounded-2xl font-black text-lg btn-modern shadow-2xl'},'ğŸ”„ Nouveau'),
                        e('label',{htmlFor:'upload',className:'bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-600 text-white px-10 py-4 rounded-2xl font-black text-lg btn-modern shadow-2xl cursor-pointer'},'ğŸ“ Import',e('input',{type:'file',id:'upload',accept:'.json',onChange:uploadJSON,className:'hidden'})),
                        e('button',{onClick:downloadJSON,className:'bg-gradient-to-r from-green-500 via-emerald-500 to-teal-600 text-white px-10 py-4 rounded-2xl font-black text-lg btn-modern shadow-2xl'},'ğŸ’¾ Export'),
                        e('button',{onClick:()=>setEditMode(!editMode),className:`px-10 py-4 rounded-2xl font-black text-lg btn-modern shadow-2xl ${editMode?'bg-gradient-to-r from-red-500 to-pink-600 text-white':'bg-gradient-to-r from-amber-500 to-orange-600 text-white'}`},editMode?'âŒ Fermer':'âœï¸ Modifier')
                    )
                ),

                e('div',{className:'scroll-container glass-effect'},
                    e('table',{className:'table-container'},
                        e('thead',null,
                            e('tr',null,
                                e('th',{className:'th-worker border-b-4 border-blue-500'},'ğŸ‘· OUVRIER'),
                                Array.from({length:daysInMonth},(_,i)=>e('th',{key:i,className:`day-cell border-b-4 ${dailyCoverage[i] ? 'border-green-400 bg-gradient-to-b from-green-700 to-green-800' : 'border-red-400 bg-gradient-to-b from-red-700 to-red-800'}`},e('div',{className:'text-lg font-black'},i+1),e('div',{className:'text-[10px] font-bold tracking-wide'},getDayName(year,month,i+1)))),
                                e('th',{className:'th-total border-b-4 border-green-500'},'ğŸ“Š REPOS')
                            )
                        ),
                        e('tbody',null,
                            workers.map((worker,wIdx)=>
                                e('tr',{key:wIdx,className:'border-b-2 hover:bg-purple-50/50 transition-all'},
                                    e('td',{className:'td-worker border-r-4 border-blue-300'},e('div',{className:'font-black text-sm'},worker)),
                                    schedule.map((day,dIdx)=>{
                                        const assignment = day.workers[wIdx];
                                        return e('td',{
                                            key:dIdx,
                                            className:`day-cell ${editMode ? 'cell-hover' : ''} ${getCellStyle(assignment)} border-r-2 border-white/50 transition-all`,
                                            onClick:()=>clickCell(dIdx,wIdx)
                                        },e('div',{className:'text-[10px] leading-tight'},assignment||'â€”'));
                                    }),
                                    e('td',{className:'td-total border-l-4 border-green-300'},e('div',{className:'text-xl font-black'},`${stats[wIdx].restDays}j`))
                                )
                            )
                        )
                    )
                ),

                showOptions && e('div',{className:'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[1000] animate-fadeIn',onClick:()=>{setShowOptions(false);setSelectedCell(null);}},
                    e('div',{className:'glass-effect p-10 rounded-3xl shadow-2xl border-4 border-white/40 max-w-lg w-full animate-slideIn',onClick:ev=>ev.stopPropagation()},
                        e('h3',{className:'text-4xl font-black text-center mb-8 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent'},'ğŸ¯ Modifier Statut'),
                        e('div',{className:'grid grid-cols-2 gap-4'},
                            options.map(opt=>e('button',{
                                key:opt,
                                onClick:()=>selectOption(opt),
                                className:`p-6 ${opt === 'CongÃ© PÃ©riode' ? 'col-span-2 bg-gradient-to-r from-lime-400 to-emerald-500' : 'bg-gradient-to-br from-blue-400 to-indigo-500'} hover:scale-105 text-white rounded-2xl border-2 border-white/50 font-black text-base shadow-xl transition-all`
                            },opt === 'CongÃ© PÃ©riode' ? 'ğŸ“… CongÃ© (PÃ©riode)' : opt))
                        ),
                        e('button',{onClick:()=>{setShowOptions(false);setSelectedCell(null);},className:'w-full mt-8 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-5 rounded-2xl font-black text-xl btn-modern shadow-xl'},'âŒ Annuler')
                    )
                ),

                showPeriodModal && e('div',{className:'fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[1100] animate-fadeIn',onClick:()=>{setShowPeriodModal(false);setPeriodStart('');setPeriodEnd('');}},
                    e('div',{className:'glass-effect p-12 rounded-3xl shadow-2xl border-4 border-white/40 max-w-xl w-full animate-slideIn',onClick:ev=>ev.stopPropagation()},
                        e('h3',{className:'text-4xl font-black text-center mb-10 bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent'},'ğŸ“… PÃ©riode de CongÃ©'),
                        e('div',{className:'space-y-8'},
                            e('div',{className:'space-y-3'},
                                e('label',{className:'block text-xl font-black text-gray-700'},'ğŸ“ Du jour:'),
                                e('input',{type:'number',value:periodStart,onChange:ev=>setPeriodStart(ev.target.value),min:1,max:daysInMonth,placeholder:'1',className:'w-full px-8 py-5 text-3xl font-black text-center bg-blue-100 border-4 border-blue-400 rounded-2xl focus:ring-4 focus:ring-blue-500 shadow-lg'})
                            ),
                            e('div',{className:'text-center text-4xl font-black text-purple-600'},'â†“'),
                            e('div',{className:'space-y-3'},
                                e('label',{className:'block text-xl font-black text-gray-700'},'ğŸ“ Au jour:'),
                                e('input',{type:'number',value:periodEnd,onChange:ev=>setPeriodEnd(ev.target.value),min:1,max:daysInMonth,placeholder:daysInMonth,className:'w-full px-8 py-5 text-3xl font-black text-center bg-blue-100 border-4 border-blue-400 rounded-2xl focus:ring-4 focus:ring-blue-500 shadow-lg'})
                            )
                        ),
                        e('div',{className:'flex gap-4 mt-10'},
                            e('button',{onClick:applyPeriod,className:'flex-1 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white py-6 rounded-2xl font-black text-xl btn-modern shadow-2xl'},'âœ… Appliquer'),
                            e('button',{onClick:()=>{setShowPeriodModal(false);setPeriodStart('');setPeriodEnd('');},className:'flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-6 rounded-2xl font-black text-xl btn-modern shadow-2xl'},'âŒ Annuler')
                        )
                    )
                ),

                e('div',{className:'glass-effect p-10 rounded-3xl border-4 border-white/40 shadow-2xl animate-fadeIn'},
                    e('h3',{className:'text-4xl font-black text-center mb-8 bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent'},'ğŸ“Š Statistiques du Mois'),
                    e('div',{className:'grid grid-cols-1 md:grid-cols-3 gap-6 mb-8'},
                        fullCoverage === daysInMonth ? 
                            e('div',{className:'badge-success text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'ğŸ‰'),
                                e('div',{className:'text-2xl font-black'},'COUVERTURE'),
                                e('div',{className:'text-4xl font-black mt-2'},'100%')
                            )
                        :
                            e('div',{className:'badge-error text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'âš ï¸'),
                                e('div',{className:'text-2xl font-black'},'INCOMPLET'),
                                e('div',{className:'text-3xl font-black mt-2'},`${fullCoverage}/${daysInMonth}`)
                            ),
                        maxConsecutiveRest <= 2 ?
                            e('div',{className:'badge-success text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'âœ…'),
                                e('div',{className:'text-2xl font-black'},'MAX REPOS'),
                                e('div',{className:'text-4xl font-black mt-2'},'2j')
                            )
                        :
                            e('div',{className:'badge-error text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'âŒ'),
                                e('div',{className:'text-2xl font-black'},'ERREUR'),
                                e('div',{className:'text-3xl font-black mt-2'},`${maxConsecutiveRest}j`)
                            ),
                        maxReservePerDay <= 1 ?
                            e('div',{className:'badge-success text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'ğŸ”¶'),
                                e('div',{className:'text-2xl font-black'},'RÃ‰SERVE'),
                                e('div',{className:'text-4xl font-black mt-2'},'1 MAX')
                            )
                        :
                            e('div',{className:'badge-error text-white p-8 rounded-2xl text-center shadow-2xl'},
                                e('div',{className:'text-5xl mb-2'},'âŒ'),
                                e('div',{className:'text-2xl font-black'},'RÃ‰SERVES'),
                                e('div',{className:'text-3xl font-black mt-2'},maxReservePerDay)
                            )
                    ),
                    e('div',{className:'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6'},
                        stats.map((stat, i) =>
                            e('div',{key:i,className:'stat-card text-white p-8 rounded-2xl shadow-2xl text-center'},
                                e('div',{className:'font-black text-3xl mb-4'},`O${i+1}`),
                                e('div',{className:'text-5xl font-black mb-2'},`${stat.workDays}`),
                                e('div',{className:'text-sm font-bold mb-4 opacity-90'},'jours travail'),
                                e('div',{className:'text-3xl font-black text-yellow-300 mb-1'},`${stat.reserveDays}`),
                                e('div',{className:'text-xs font-bold mb-4 opacity-80'},'rÃ©serves'),
                                e('div',{className:'text-3xl font-black text-red-300'},`${stat.restDays}`),
                                e('div',{className:'text-xs font-bold opacity-80'},'jours repos')
                            )
                        )
                    )
                )
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
</body>
</html>
